#!/bin/sh

BACKUP=/tmp/backup
DEST=$BACKUP/archive/
TRASH=$BACKUP/archive/

mkdir -p $DEST
mkdir -p $TRASH

CURDAY=`date "+%d"`

# This is going to be cutting into the previous month
#  perhaps the previous year.
if [ $CURDAY -le 7 ]
then
 CUTOFFMONTH=`date "+%m"`
 if [ $CUTOFFMONTH -eq 1 ]
 then
  CUTOFFMONTH=12
 else
  CUTOFFMONTH=$(($CUTOFFMONTH - 1))
 fi
 
 CUTOFFYEAR=`date "+%Y"`
 if [ $CUTOFFMONTH -eq 12 ]
 then
  CUTOFFYEAR=$(($CUTOFFYEAR - 1))
 fi

 # See if date 28 - (7 - CURDAY) exists. then increase 28 up to 31.
 for (( CHECKDATE=$((28 - (7 - $CURDAY)));
        $CHECKDATE <= 31;
        CHECKDATE=$(($CHECKDATE + 1)) ))
 do
  CHECKDATES="$CHECKDATES $CHECKDATE"
 done

 for LASTDAY in $CHECKDATES
 do
  if [ -z $CUTOFFDAY ]
  then
   if test -e $BACKUP/backup-cvs-$CUTOFFYEAR-$CUTOFFMONTH-$LASTDAY.dmg
   then
    CUTOFFDAY=$LASTDAY
   fi
  fi
 done

 CUTOFFDATE=$CUTOFFYEAR-$CUTOFFMONTH-$CUTOFFDAY
else
 CUTOFFDAY=$(($CURDAY - 7))
 CUTOFFDATE=`date "+%Y-%m-"`$CUTOFFDAY
fi

# Find the oldest file matching the cutoff date
cd $BACKUP
OLDESTCUTOFF=`ls -1t backup-*-$CUTOFFDATE.dmg | tail -1`

# Find the files older than the cutoff date and clean them up
FILESTOCLEANUP=`find $BACKUP -not -newer $OLDESTCUTOFF -and -not -name $OLDESTCUTOFF`

echo These files would be trashed:
if [ -z $FILESTOCLEANUP ]
then
 echo $FILESTOCLEANUP
 mv $FILESTOCLEANUP $TRASH
#rm $FILESTOCLEANUP
fi

# Copy the cutoff date files to the archive location
cp $BACKUP/backup-*-$CUTOFFDATE.dmg $DEST

echo These files should be archived:
echo `ls -1t $DEST`
